.. note::
    :class: sphx-glr-download-link-note

    Click :ref:`here <sphx_glr_download_auto_examples_armodel_plot_ar_condcovgc.py>` to download the full example code
.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_armodel_plot_ar_condcovgc.py:


AR : conditional covariance based Granger Causality
===================================================

This example reproduces the results of Ding et al. 2006 :cite:`ding2006granger`
where in Fig3 there's an indirect transfer of information from Y->X that is
mediated by Z. The problem is that if the Granger Causality is used, there's
indeed a transfer of information from Y->X while with the conditional Granger
causality, conditioning by the past of other sources suppresses this indirect
transfer.


.. code-block:: default

    import numpy as np

    from frites.simulations import StimSpecAR
    from frites.conn import conn_covgc

    import matplotlib.pyplot as plt








Simulate 3 nodes 40hz oscillations
----------------------------------

Here, we use the class :class:`frites.simulations.StimSpecAR` to simulate an
stimulus-specific autoregressive model made of three nodes (X, Y and Z). This
network simulates a transfer Y->Z and Z->X such as an indirect transfer from
Y->X mediated by Z


.. code-block:: default


    ar_type = 'ding_3_indirect'  # 40hz oscillations
    n_stim = 2                   # number of stimulus
    n_epochs = 50                # number of epochs per stimulus

    ss = StimSpecAR()
    ar = ss.fit(ar_type=ar_type, n_epochs=n_epochs, n_stim=n_stim)







plot the network


.. code-block:: default


    plt.figure(figsize=(5, 4))
    ss.plot_model()
    plt.show()




.. image:: /auto_examples/armodel/images/sphx_glr_plot_ar_condcovgc_001.png
    :class: sphx-glr-single-img




Compute the Granger-Causality
-----------------------------

We first compute the Granger Causality and then the conditional Granger
causality (i.e conditioning by the past coming from other sources)


.. code-block:: default


    dt, lag, step = 50, 5, 2
    t0 = np.arange(lag, ar.shape[-1] - dt, step)
    kw_gc = dict(dt=dt, lag=lag, step=1, t0=t0, roi='roi', times='times',
                 n_jobs=-1)
    # granger causality
    gc = conn_covgc(ar, conditional=False, **kw_gc)

    # conditional granger causality
    gc_cond = conn_covgc(ar, conditional=True, **kw_gc)






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

      0%|          |  : 0/3 [00:00<?,       ?it/s]    100%|##########|  : 3/3 [00:00<00:00, 3526.60it/s]
      0%|          |  : 0/3 [00:00<?,       ?it/s]    100%|##########|  : 3/3 [00:00<00:00, 3811.85it/s]



Plot the Granger causality


.. code-block:: default


    plt.figure(figsize=(12, 10))
    ss.plot_covgc(gc)
    plt.tight_layout()
    plt.show()





.. image:: /auto_examples/armodel/images/sphx_glr_plot_ar_condcovgc_002.png
    :class: sphx-glr-single-img




Plot the conditional Granger causality


.. code-block:: default


    plt.figure(figsize=(12, 10))
    ss.plot_covgc(gc_cond)
    plt.tight_layout()
    plt.show()





.. image:: /auto_examples/armodel/images/sphx_glr_plot_ar_condcovgc_003.png
    :class: sphx-glr-single-img




Direct comparison
-----------------

In this plot, we only select the transfer of information from Y->X for both
granger and conditional granger causality


.. code-block:: default


    # select Y->X and mean per stimulus for the granger causality
    gc_yx = gc.sel(roi='x-y', direction='y->x').groupby('trials').mean('trials')
    gc_yx = gc_yx.rename({'trials': 'stimulus'})

    # select Y->X and mean per stimulus for the conditional granger causality
    gc_cond_yx = gc_cond.sel(roi='x-y', direction='y->x').groupby('trials').mean(
        'trials')
    gc_cond_yx = gc_cond_yx.rename({'trials': 'stimulus'})

    # get (min, max) of granger causality from Y->X
    gc_min = min(gc_yx.data.min(), gc_cond_yx.data.min())
    gc_max = max(gc_yx.data.max(), gc_cond_yx.data.max())

    # sphinx_gallery_thumbnail_number = 4
    plt.figure(figsize=(10, 5))
    # plot granger causality from Y->X
    plt.subplot(121)
    gc_yx.plot.line(x='times', hue='stimulus')
    plt.title(r'Granger causality Y$\rightarrow$X', fontweight='bold')
    plt.axvline(0, color='k', lw=2)
    plt.ylim(gc_min, gc_max)
    # plot the conditional granger causality from Y->X
    plt.subplot(122)
    gc_cond_yx.plot.line(x='times', hue='stimulus')
    plt.title(r'Conditional Granger causality Y$\rightarrow$X|others',
              fontweight='bold')
    plt.axvline(0, color='k', lw=2)
    plt.ylim(gc_min, gc_max)
    plt.tight_layout()

    plt.show()



.. image:: /auto_examples/armodel/images/sphx_glr_plot_ar_condcovgc_004.png
    :class: sphx-glr-single-img





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  29.798 seconds)


.. _sphx_glr_download_auto_examples_armodel_plot_ar_condcovgc.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download

     :download:`Download Python source code: plot_ar_condcovgc.py <plot_ar_condcovgc.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: plot_ar_condcovgc.ipynb <plot_ar_condcovgc.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
